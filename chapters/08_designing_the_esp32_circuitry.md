# Designing the ESP32 Circuitry

thing I don't have a value for R6 so let's do that now so R6 should be 20K I'm pretty confident that this is correct now I haven't forgotten anything so we can continue now with the second sheet let's continue with the second sheet which will contain the various circuitry relating to the es32 and things such as the USB module flash memory in the SD card module I'll put all those in the second sheet so you can get to the second sheet either by clicking here in the schematic herc just a second sheet you can reveal that

window by clicking on this button here in the left toolbar HC Navigator or you can double click on the hierarchy symbol in the first sheet just double click and all get you there and another thing that you can do that I always like to do is to go into the symbols property and just change the fill color so that it's a little bit easier to see I'm just going to make it something like this with a bit of opacity so kind of look a little bit like this a bit more interesting and and striking later on you'll see that

I'm going to attach labels to this box in order to enable Communications between the two sheets so let's go ahead second sheet and just like before I'm going to start by dropping the major components onto the sheet and to make it a little bit easier for us to know what those components are I've gone to the bomb and I have highlighted with yellow the main components that are part of this sheet so we have the memory card connector it's the SD card connector the esp32 chip the cp2102 which is a usb2 uart bridge got

another chip that acts as an ESD suppressor that will be working alongside the USB to UI Bridge I'll talk a little bit more about this in a moment and finally the flash memory chip uh let's start with the USB module I'll hit the a key and I'll search for GSD 0900 and there it is I'll place that somewhere here I'll continue just you can see what I'm doing I'll continue with the the next item in my list which is the esp32 u3 component so I'm just going to search for that see3 the one that I want is this one okay and drop that there next up in my

list I've got the USB to U bridge cp2102 and I'm looking for the G qfn 20 package so I'd go 20 this one here place that here one more is the flash memory so that is this item down here actually sorry I skipped one u5 that's the ESD suppressor so let's look for that first I've got a few options there the one that I want is this one right there the differences have to do with the packaging not with the schematic itself you can see the first two have got six pins out it's just the packaging is slightly different so the one that

I'm going to go for is the 2s C6 and then finally I've got the U6 component which is The Flash SBI flash chip so that's W2 5 q this one here there's a few options but that's the one that I'm looking for double click and I'll place it say here before I continue I'm going to review the designators for the components just to make sure that they match with the ones I'm using in my notes because if I don't there's a high chance I'm going to make mistakes later on so the USD suppressor chip I'm going to rename that

to u5 the USB to serial bridge that is going to be u4 the ESP 32 Chip is going to be u3 the SD card module is j3 that's correct and then finally the flash memory that is going to be U6 I suggest you do that as well if you want to keep track of what I'm doing because I'll be referring to these components by the designators and all I'm trying to do here is to make sure that the notes and the designators in my notes with the various components match with what I have in the actual schematic so that's all I'm doing here now let's

talk a little bit about these components this integrated circuit you 4 is a usb2 uard bridge and it enables Communications between a computer and the esp32 C3 module via a USB connection so it converts USB signals to serial U signals making it possible to program and debug the esp32 C3 directly from the computer while handling USB power delivery to the board so that's the purpose of this chip now alongside this chip is our smaller chip this u5 USB lc6 and this is is a ESD suppressor chip this chip here protects the bridge the

USB serial Bridge from electrostatic discharge events which can occur during handling or when plugging in USB connections so it clamps high voltage spikes to safe levels preventing damage to the chip while maintaining signal Integrity for Reliable data communication so I'm also going to follow the information in the data sheets for all of the wiring that you're about to see so for example I've got the documentation for the esp32 chip I showed you some of this a little earlier actually a better place to look for that

information is the development kit schematic diagram so for example here you can see how expressive themselves have wired the esp32 module to power and to ground and I'll be following this example as well in particular be implementing the reset and boot Button functionality following this exact schematic so that's one place to look for another thing to show you is the cp2102 chip this is the USB 2 serial bridge and there's a lot of information here on how to do the wiring I'm not going to go through it because it's a

lot of detail it will take a while but if you are interested in learning the details and understanding why I did what I did the way I did it have a look at these data sheets as well here's a data sheet for the SD card module this is mostly mechanical there's not much else going on so I've looked at this just to get a better understanding of the mechanical attributes of this connector and finally I've got here the data sheet for the flush memory this is NBI interface flush memory it doesn't have specific information on how to do their

wiring but I'm using conventions for wiring integrated circuits that communicate with with a host using High data rates and high frequencies let's begin I'm going to start with the top left side of my schematic and work my way to the other components so since I've got the ESD protective circuit I'm just going to move these two bits to the side for the time being at least okay I'm just going to reorient this component to make wiring easier pin two goes to ground I'm just going to grab a ground pin from here 

place that there so that's going to be ground going to leave pin five alone for a second because I need a couple of resistors for that it's a voltage ladder next three just going to flip this component across so select it and just click on this button up here to mirror vertically because I want pin three to be up on the top side just makes wiring easier so pin 3 will go to to pin 4 on the USB to serial bridge and pin one will go to Five pins four and six need to be connected to pins in the root page so to do that I'm going to use this

button here to create hierarchical labels so the first label is USB DN so USB DN and for negative I do have flexibility on to where to connect it but I'm going to connect that to six to pin six to begin with and I'm going to create a duplicate of this label double click on the duplicate and change this end to P for the positive side of this differential pair so I've got USB DP connected to pin 4 and USB DN connected to pin 6 now in the root page I'm going to use the place sheet pins tool to expose their two uh sheet labels

I just created in the rout so click on that click here and you can see some clicking and then click again to commit um bringing across the two labels the two hierarchical labels that are created in the second sheet so these two and now exposed to the first sheet right here and I can actually finish the connection of those two sheets by connecting you can see there's pins here that I can connect to something else so I'm going to grab the two labels that I've already created these two create a duplicate then bring them down here to finish the

connection so I've got the DN that needs to go right there I'm just going to use Y is for that and DP that goes there use wires to finish the connection the two pages now the two sheets are now able to communicate let's go back to the second sheet and I'm going to finish this work for this particular component by adding the two resistors to form a resistor ladder so there's the first one just R there's one here and another one here it's going to be R12 and the value for R12 is 22.

1 K or I'm going to call it 22 K1 the second one its designator is 13 and its value 47.5 KMS these two form a voltage ladder for VBS like this just move it down a bit and then the other side of r13 goes to ground like that on the top side we've got vbus so vbus of course is coming into this shade from the rude shade so I'm going to create one more hierarchical label called vbus and connect that here and go back to the rout and expose it like that and from here I need to find a vbus label to bring across done back to the second sheet one thing

to notice is that these labels have got shapes so depending on what shape you use you can see that the shape of the label itself changes as well these are really just visual so I'm going to keep them as inputs here and the VB is also an input next I'm going to take a wire from pin five and connect it to vbus so that's how this chip is being powered or if you don't like the label you can just use vbus I'll do that actually just to minimize the number of wires that I'm using all right now while I'm at it I'm going to create a few local and named

nits so the first one is going to be USB data plus so I'm going to connect that to the P right there and the other one is going to be the minus again this is going to be a differential pair so I'm using plus and minus so that later on when I go to the layout editor and I start doing the drawing of the tracers Kart will be able to tell that these two wires belong to the same differential pair because they've got the minus and the plus signs in their net names now as per the specifications for this device in the data sheet I also need a

capacitor just a regular capacitor will do going to place it here connect the other side to ground just move that a bit further down like this and that goes up here and this capacitor is going to be C11 and its value is going to be 1 micro farad and let's continue going to have one more ground down  here and up on the top side actually I need to move everything down a bit because I have a few components to connect up on the top side so I'm going to start with a resistor oriented like this this resistor will be

R11 and it's going to be 1K that will be connected between the reset pin and pin seven which is the voltage regulation in and I'm going to connect vdd in there as well to the same pin then I've got two bypass capacitors one of them is going to be a regular capacitor and the other one is going to be electrolytic or polarized oriented like that let's set the values so the one in the bottom is going to be C10 and its value 0.

1 microfarads and the polarized one is going to be C9 and its value is 4.7 U it goes there and then these two go to ground like that and on the top side I'm going to have a 3.3 volt symbol so that side is done uh on the right side I'm just going to Mark a few pins that I won't be using first do not connect that and that and the suspend pins we don't need wake up either after that that I want to have two LEDs to indicate traffic so you can see txt and RTX so I'll connect two pins here to show when there is traffic so I'm going

to copy this block of components blue and a red LED along with the resistors so command C go back to the working shet and paste those here this saves time just Orient like that so I'm going to put the uh green LED day actually on the top side again this is totally arbitrary of course but in order to do myself the courtesy of not making a mistake and diverging from my notes I'm just uh making sure that what I'm drawing here reflects what I have in my notes all right and these two then will go to the 3.

3 volt just going to copy this symbol and place it right here here I've got txt rxt and the RTS and CTS and instead of wiring them using actual wires I'm just going to use labels here so this one the first one is going to be TX RX and that goes here and the second one duplicate is going to be rxtx goes there next RTS and finally we have I'll call this one DTS okay I think this is complete so I'm going to put this in a box move it down a little and give it a name this is the USB module okay looks okay I'm going to have

another look at it later on before I commit let's work on the ESP 32 module so I'm going to laser in here because I'm going to have more components on the right side I just noticed that this resistor should be 18 R 18 so let's begin here I'm going to start by dropping a new resistor place it here next to I6 and this is a small 50 Ohm resistor all right so that goes to I6 and on the other side we'll connect the to S CK net after that I've got several net labels to create and attach to these pins right here and down the

bottom right there so start with the ones that I've already created so I can just duplicate them so first I'm just going to copy these two create duplicates and move them over to this side and rotate and just connect them to pins 12 and 11 and that's good next up I've got a bunch of net labels to create so I'm going to use the L key for that so the first one for up here pin two this is going to be en n for enable done next one it's going to be cscore SD that's going to go to io0 so they're all for all those pins

just by the way if if you are a little bit confused right now we'll find all that information in the data sheet right here so there is a table here right here that tells you about the roles of each one of the pins so that you know what label to create in order to connect that pain to a particular net so next up is io1 which is going to be connected to the sensor I've connected that to the photo sensor so this is a purpose Pinn you can do whatever you want with it of course but I've decided to connect this particular one to the photo sensor next

I've got the SBI interface so I'll create a a new label called misso do for data output and that goes to io2 then there is SC for the I squid C interface and SDA and for I5 there another general purpose input output uh and I've connected it to the microphone so I'm using the MC out net to convey signal from the microphone or from the sound sensor so the left side is done let's go over to the other side now I'll continue with some more labels since I've started that process this going to be uh gp19 so that goes there I'm going to

connect this particular net to one of the headers that's gp18 next one up is going to be CS or chip select for the SBI interface and that's going to be Boot and gp8 this one is going to be connected to the boot Button just like uh this one here goes to the enable button three pins remaining I'm going to duplicate the ground symbol so that I can connect it to the ground pin right there then I've got io7 for io7 I need a resistor so add a resistor oriented like this so This resistor is 50 ohms and it goes to Mossy

so there's another label start a input for the SP interface this is going to be R15 this R15 and I need to correct this one here this is R 20 and finally the power for this esp32 module as per the specifications I'm going to connect this power to 3.3 volts that but I also need a couple of capacitors for bypass and for or just signal conditioning so I'm going to have two capacitors there one polarized and one unpolarized or ceramic so there's the ceramic one and let's put one more polarized I'll place that there like

this I'm just going to switch the names so C7 should really be C8 to remain consistent with my notes that's going to be 0.1 U or 0.1 microfarads okay and the other one is going to be C7 and its value is 10 microfarads connect these to ground and on the top side just going to use the W key to start drawing just going to draw it like that actually I think makes more sense if I draw it like this yeah I'm going to move all this down a bit so because just to CH the number of angles that appear so like this G key just to make it look

a little nicer I think this is good as it is put a box around it and give it a name done let's continue with the SD card module so this is a SBI device so it it communicates with the esp32 using SPI so start with connecting the SPI and then uh there's a couple of capacitors in resistance as well for Signal conditioning I'm going to grab the mossy and miso and clock there's clock and the select I just noticed a mistake actually I'll unclick everything this is the select signal for the SD card so it should be SC for select SD for SD

card all right so let's try again so that that clock and that duplicate them and bring them all say around here so I can attach them to the SD card reader module so Mossy goes on this side here clock goes here the chip select goes here but I will need to add a resistor this is just a pull up resistor I'll just place it here and set it up so this is r19 and the value of this resistor is  10K and as I said this is a pull up resistor so I'll just draw it like this pulls up to 3.

3 volts I can just make this a little bit more economical with space and just connect it straight like that G to make it look better okay and then finally I've got the Miso and that eventually goes here just going to move this out of the way for a moment okay that goes to that zero pin but I need a resistor a small resistor again signal conditioning right there that is going to be R16 and just 50 ohms make sure because I hit Escape so it didn't commit so R16 50 ohms and that goes there are done just move these two out a bit using

the G key that one and Dot two along with the pins down here all go to ground so I'm just going to get a ground component place it there rearrange a few things actually I don't really need this long wire I'm just going to move this simple databit rotate and connect straight like that all right next I've got that one goes to ground that two goes to ground move these two labels up there and also I've got actually I'll be yeah I'll be economical with space and yse I'm just going to do one more ground there and all these go to ground

then I'm going to Mark these pins on the left as do not connect and then I've got one pin remaining which is the power input for this module so for that I need a couple of capacitors uh just like with the other examples earlier and it's so happens that these capacitors are the same values as those are used up here in the 32 so I'm just going to copy those and duplicate and I've got C12 is meant to be the electrolytic so I'm just going to change the designations so this is going to be 12 at 10 microfarads and this is going to be

13 at 0.1 and that goes right there and finally I've got the 3.3 volt to power the module I'll bring the grounds down here so that kind of the at the same level looks a bit better and that is it with a module for the SD card put it in a box give it a name one more thing to mention here is that the dot 2 pin on the micro SD card is typically used in 4bit SD mode as one of the four data lines we've got data line 0 1 2 and three four data lines in total however in SPI mode which is commonly used in microcontroller applications like the

ones that we are building here the dot two pin is not required and it can be left floating or better connected to ground which is what we're doing here so in SPI mode which is the mode that we are again using here only the following pins are actively used we've got data zero you see I've connected that to miso data out CMD which is connected to miso data in clock right here and CS right here the cheap select and then againt 2 and one are not used in SBI mode one more thing to do and that's to connect and wire up the flash memory so

the flash memory is also using the SBI interface so I'm going to duplicate some of the relevant pins so these four going to move them over here there is one more for the chip select I'm using this one here duplicate that and move it over across to this side let's do the wiring so CS goes here clock goes here Mossy goes here data input di di miso data output goes there do okay data out put actually I need to do conditioning here so let's just remove that out of the way and I need another small resistor just going to copy the one from

here this one duplicate it and move it over this side so this is 50 ohms and this should be R22 actually I'll move all that a little bit to the left because I need to do something with pin number three right there so pin three along with hold will go to 3.3 volts so we're going to be holding those high at a high level that goes there and that goes there better and on the other side I need just a single capacitor so bypass capacitor to connect ground to ground and on the other side VCC will go to 3.

3 volts it's going to be c14 and 0.1 micro farads is sufficient so move that a bit closer and we're done all right let's put this in a box and this is going to be the flash memory almost done with this page from this page that contains the esp32 we are going to Branch out to two other pages one is going to contain the hardware for the sensors and the other one for the user interface so just like earlier I'm going to create the hierarchical sheets for those two additional pages and I'll start with the shade for the sensus I'll

call that sensus and the shade file will be sensus and I'll give it a color let's make it sign in and the second one is going to be for the user interface so that's user interface and for the sheet name I'll just a user interface and I'll use uh Fu color I'm going to make that orange okay let's try again with a sensors let's go to the properties I clicked on the B water instead of the fuel s in all right that's better okay so we're going to add bits and pieces in those boxes later when we uh start work on the sensors and the user interface so save

just going to do one last cross check before I leave this sheet alone for now oh yeah one thing that I haven't done was to fill the the data in the legend down here so let's do that so this is going to the esp32 C3 USB and um flash memory okay that's good save just going to take a moment to check everything here's one thing that I forget I'm just going to do it now before we continue what I want to do is to have a few test points in the final PCB so these are pads on the board that I'll be able to attach test instruments just to check on

the operation of the board without having to tap onto pins so I'm going to add a few test points here to do that I'm going to move these two blocks a bit to the right just to make a bit of room and I'm going to add the test points right here so tap the a key search for test points you can see there's a test Point here I'm going to go for the just simple test point looks like this Orient them like this or like this doesn't really matter so this first one is going to be Mossy just going to duplicate them I want to have five of those I want to

be able to test the SP interface so 1 2 3 4 One More five so I want to have Mossy miso clock and the two select p duplicate those just put them up here for now so the first test point is going to be Mossy place that right there second one is going to be misso then I'll have the clock and then I'll have the chip select signals so for the SD card and for the flash memory I change the name so this going to be test I use lowcase test Mossy test miso test s k o clock test CS SD and finally test CS give a bit of

space before I move to the next sheet just notice one thing here I'd really like to have this capacitor on the left side so that it's closer to vdd so the way to do this really quickly and easily is to just select the two and then use this button up here mirror horizontally or just type X and it will flip it across and I use G just move the bundle of components together to the one side do the same thing again down here so that everything is nice and symmetrical so I'm going to save and then continue with the next sheet which is the sensus

shet let's continue with the next shet in line which is the sensus shet so in here I am going to create a circuitry for these main components the microphone preamplifier the BME 280 environment sensor it's the ambient light sensor and the microphone already collected of course the data sheets for these components you can see here is's a data sheet for the um microphone preamplifier fairly straightforward I'll be implementing this circuitry right here here is the ambient light sensor fairly straightforward to implement the

microphone that works with the preamplifier and the data sheet for the bme280 also fairly straightforward to implement there's nothing to it really uses the r s c interface and we can just follow the general gu lines for any i s c interface device to connected as always I'm going to start by dropping the main components onto my designer that's the BME 280 start with that next I'll add the microphone and the preamplifier CMC 50 that's one I downloaded from snapa a bit earlier so that goes there and I also need to get

the preamplifier which is model number Max 446 6 exk that one right there so place that right here and uh then there's also the photo sensor so I'll put that up the top so there's going to be T Mt right there I'm just making use of my previous research here so that I can search by the various model numbers or other keywords obviously I don't remember those things by heart I'm going to start with the BME 280 and um set up the supporting circuitry it's pretty simple so this is just an i s c device so I only need a couple of resistors for

the pullup for the two lines for the clock and for the data line so add a resistor here this is going to be a 4.7 KMS resistor 4. 7K or better 4K 7 and I'm going to call this r24 and I need two of those because I've got two lines that I need to pull up so there going to be the same value but it's going to be r25 okay done and I'm going to get a 3.
